<%- include('partials/header') %>

<div class="product-detail-section">
    <div id="message" style="display: none; text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 5px;"></div>
    <div class="product-detail-container">
        <div class="product-image-gallery">
            <div class="main-image">
                <img id="mainImage" src="<%= product.image || 'https://via.placeholder.com/400' %>" alt="<%= product.name %>">
            </div>
            <div class="thumbnail-gallery">
                <% (product.images || [product.image]).forEach((image, index) => { %>
                    <% if (image) { %>
                        <img src="<%= image %>" alt="Thumbnail <%= index + 1 %>" onclick="changeMainImage('<%= image %>')">
                    <% } %>
                <% }) %>
            </div>
        </div>
        <div class="product-info">
            <h2><%= product.name %></h2>
            <p class="category">Danh mục: <%= product.category ? product.category.name : 'Không xác định' %></p>
            <p class="price"><%= product.price.toLocaleString('vi-VN') %>đ</p>
            <p class="stock">Tồn kho: <%= product.quantity %> sản phẩm</p>
            <p class="description"><%= product.description || 'Không có mô tả.' %></p>
            <form action="/cart" method="POST" class="add-to-cart-form" id="addToCartForm">
                <div class="form-group">
                    <label for="quantity">Số lượng:</label>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" max="<%= product.quantity %>">
                </div>
                <input type="hidden" name="productId" value="<%= product.id %>">
                <button type="submit" class="add-to-cart-button">Thêm vào giỏ hàng</button>
            </form>
            <a href="/product/list" class="back-to-shop">Quay lại cửa hàng</a>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function changeMainImage(imageSrc) {
    document.getElementById('mainImage').src = imageSrc;
}

// Kiểm tra cookie message hoặc error
const message = getCookie('message');
const error = getCookie('error');
const messageDiv = document.getElementById('message');
if (message) {
    messageDiv.style.display = 'block';
    messageDiv.style.backgroundColor = '#d4edda';
    messageDiv.style.color = '#155724';
    messageDiv.textContent = message;
    document.cookie = 'message=; Max-Age=0; path=/';
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}
if (error) {
    messageDiv.style.display = 'block';
    messageDiv.style.backgroundColor = '#f8d7da';
    messageDiv.style.color = '#721c24';
    messageDiv.textContent = error;
    document.cookie = 'error=; Max-Age=0; path=/';
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

document.getElementById('addToCartForm')?.addEventListener('submit', async function(e) {
    e.preventDefault(); // Ngăn submit mặc định

    const form = e.target;
    const productId = form.querySelector('input[name="productId"]').value;
    const quantity = form.querySelector('input[name="quantity"]').value;

    try {
        const response = await fetch('/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId: Number(productId),
                quantity: Number(quantity),
            }),
        });
        if (response.ok) {
            window.location.href = '/cart';
        } else {
            const errorText = await response.text();
            alert('Lỗi khi thêm vào giỏ hàng: ' + errorText);
        }
    } catch (err) {
        console.error('Lỗi mạng:', err);
        alert('Không thể kết nối đến máy chủ.');
    }
});
</script>

<style>
.product-detail-section {
    padding: 50px 40px;
    background-color: #fff;
    min-height: calc(100vh - 200px);
}
.product-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
}
.product-image-gallery {
    flex: 1;
    min-width: 300px;
}
.main-image img {
    width: 100%;
    max-width: 400px;
    height: auto;
    object-fit: cover;
    border-radius: 10px;
}
.thumbnail-gallery {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}
.thumbnail-gallery img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid transparent;
}
.thumbnail-gallery img:hover {
    border-color: #28a745;
}
.product-info {
    flex: 1;
    min-width: 300px;
}
.product-info h2 {
    font-size: 28px;
    margin-bottom: 10px;
}
.product-info .category {
    font-size: 16px;
    color: #666;
    margin-bottom: 10px;
}
.product-info .price {
    font-size: 24px;
    color: #dc3545;
    font-weight: bold;
    margin-bottom: 10px;
}
.product-info .stock {
    font-size: 16px;
    color: #666;
    margin-bottom: 10px;
}
.product-info .description {
    font-size: 16px;
    color: #333;
    margin-bottom: 20px;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}
.form-group input, .form-group select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    width: 100%;
    max-width: 200px;
}
.add-to-cart-button {
    padding: 10px 20px;
    background-color: #28a745;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    text-transform: uppercase;
    margin-top: 10px;
}
.add-to-cart-button:hover {
    background-color: #218838;
}
.back-to-shop {
    display: inline-block;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
}
.back-to-shop:hover {
    text-decoration: underline;
}
</style>

<%- include('partials/footer') %>